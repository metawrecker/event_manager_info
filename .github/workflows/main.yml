name: Build ZIP and Publish Release

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ensure tags/complete history are available

      - name: Set variables
        id: vars
        run: |
          # You can customize this base name however you want:
          BASE_NAME="mod_event_manager_info"
          TAG="${GITHUB_REF_NAME}"    # e.g. v1.2.3
          
          # Example custom filename: my-product-v1.2.3-20251208.zip
          ARCHIVE_NAME="${BASE_NAME}-${TAG}.zip"
          
          echo "archive_name=${ARCHIVE_NAME}" >> "$GITHUB_OUTPUT"

      - name: Create ZIP from tracked files (respects .gitignore)
        run: |
          # Create a ZIP of the current commit's tracked files
          git archive \
            --format=zip \
            --output "${{ steps.vars.outputs.archive_name }}" \
            HEAD

      - name: Create or update the release and upload asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # required by gh
        run: |
          TAG="${GITHUB_REF_NAME}"

          # Create the release if it doesn't exist, otherwise continue
          # --generate-notes will auto-populate changelog from commits
          gh release view "$TAG" >/dev/null 2>&1 || \
            gh release create "$TAG" --generate-notes

          # Upload the ZIP as a Release asset (overwrite if it exists)
          gh release upload "$TAG" "${{ steps.vars.outputs.archive_name }}" --clobber
